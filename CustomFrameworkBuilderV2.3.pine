//@version=6
// Aktualizálva: 2025-02-17 19:02
// szerző: mineheroesrpg

indicator("Custom Framework Builder v2.3", overlay=true)

// =================== Preset System ===================
string DEFAULT_PRESET = "Custom"
string selected_preset = input.string(DEFAULT_PRESET, "Preset", 
     options=["Custom", "Weekly Orderflow", "Daily Orderflow"], 
     group="Preset Settings", 
     tooltip="Select a preset configuration or use Custom for manual settings")

// =================== Input mezők ===================
// Runtime változók deklarálása
// Plot 1
var bool p1_enable = true
var string p1_candle = "Previous"
var string p1_tf = "W"
var string p1_ohlc = "H"
var string p1_style = "Solid"
var color p1_color = color.blue
var int p1_width = 2
var string p1_label = "Prev. Week high"
var bool p1_extend = false
// Plot 2
var bool p2_enable = true
var string p2_candle = "Previous"
var string p2_tf = "W"
var string p2_ohlc = "L"
var string p2_style = "Solid"
var color p2_color = color.red
var int p2_width = 2
var string p2_label = "Prev. Week low"
var bool p2_extend = false
// Plot 3
var bool p3_enable = true
var string p3_candle = "Previous"
var string p3_tf = "D"
var string p3_ohlc = "H"
var string p3_style = "Solid"
var color p3_color = color.blue
var int p3_width = 1
var string p3_label = "Prev. Day high"
var bool p3_extend = false
// Plot 4
var bool p4_enable = true
var string p4_candle = "Previous"
var string p4_tf = "D"
var string p4_ohlc = "L"
var string p4_style = "Solid"
var color p4_color = color.red
var int p4_width = 1
var string p4_label = "Prev. Day low"
var bool p4_extend = false
// Plot 5
var bool p5_enable = true
var string p5_candle = "Current"
var string p5_tf = "D"
var string p5_ohlc = "O"
var string p5_style = "Dotted"
var color p5_color = color.green
var int p5_width = 1
var string p5_label = "Current Day Open"
var bool p5_extend = false
// Plot 6
var bool p6_enable = true
var string p6_candle = "Current"
var string p6_tf = "D"
var string p6_ohlc = "C"
var string p6_style = "Dotted"
var color p6_color = color.green
var int p6_width = 1
var string p6_label = "Current Day Close"
var bool p6_extend = false
// Plot 7
var bool p7_enable = true
var string p7_candle = "Current"
var string p7_tf = "D"
var string p7_ohlc = "H"
var string p7_style = "Dotted"
var color p7_color = color.blue
var int p7_width = 1
var string p7_label = "Current Day High"
var bool p7_extend = false
// Plot 8
var bool p8_enable = true
var string p8_candle = "Current"
var string p8_tf = "D"
var string p8_ohlc = "L"
var string p8_style = "Dotted"
var color p8_color = color.red
var int p8_width = 1
var string p8_label = "Current Day Low"
var bool p8_extend = false
// Plot 9
var bool p9_enable = false
var string p9_candle = "Previous"
var string p9_tf = "D"
var string p9_ohlc = "O"
var string p9_style = "Solid"
var color p9_color = color.green
var int p9_width = 1
var string p9_label = "Custom 1"
var bool p9_extend = false
// Plot 10
var bool p10_enable = false
var string p10_candle = "Previous"
var string p10_tf = "D"
var string p10_ohlc = "O"
var string p10_style = "Solid"
var color p10_color = color.green
var int p10_width = 1
var string p10_label = "Custom 2"
var bool p10_extend = false

// Input mezők
input_p1_enable = input.bool(true, "", group="Plot 1", inline="p1", tooltip="Choose the current or the previous candles OHLC on specific timeframe.")
input_p1_candle = input.string("Previous", "", group="Plot 1", options=["Current", "Previous"], inline="p1")
input_p1_tf = input.timeframe("W", "", group="Plot 1", inline="p1")
input_p1_ohlc = input.string("H", "", group="Plot 1", options=["O", "H", "L", "C"], inline="p1")
input_p1_style = input.string("Solid", "", group="Plot 1", options=["Solid", "Dashed", "Dotted"], inline="p1_style")
input_p1_color = input.color(color.blue, "", group="Plot 1", inline="p1_style")
input_p1_width = input.int(2, "", group="Plot 1", inline="p1_style", minval=1, maxval=4)
input_p1_label = input.string("Prev. Week high", "Label", group="Plot 1", inline="p1_label")
input_p1_extend = input.bool(false, "Extend Line", group="Plot 1", inline="p1_style")

input_p2_enable = input.bool(true, "", group="Plot 2", inline="p2", tooltip="Choose the current or the previous candles OHLC on specific timeframe.")
input_p2_candle = input.string("Previous", "", group="Plot 2", options=["Current", "Previous"], inline="p2")
input_p2_tf = input.timeframe("W", "", group="Plot 2", inline="p2")
input_p2_ohlc = input.string("L", "", group="Plot 2", options=["O", "H", "L", "C"], inline="p2")
input_p2_style = input.string("Solid", "", group="Plot 2", options=["Solid", "Dashed", "Dotted"], inline="p2_style")
input_p2_color = input.color(color.red, "", group="Plot 2", inline="p2_style")
input_p2_width = input.int(2, "", group="Plot 2", inline="p2_style", minval=1, maxval=4)
input_p2_label = input.string("Prev. Week low", "Label", group="Plot 2", inline="p2_label")
input_p2_extend = input.bool(false, "Extend Line", group="Plot 2", inline="p2_style")

input_p3_enable = input.bool(true, "", group="Plot 3", inline="p3", tooltip="Choose the current or the previous candles OHLC on specific timeframe.")
input_p3_candle = input.string("Previous", "", group="Plot 3", options=["Current", "Previous"], inline="p3")
input_p3_tf = input.timeframe("D", "", group="Plot 3", inline="p3")
input_p3_ohlc = input.string("H", "", group="Plot 3", options=["O", "H", "L", "C"], inline="p3")
input_p3_style = input.string("Solid", "", group="Plot 3", options=["Solid", "Dashed", "Dotted"], inline="p3_style")
input_p3_color = input.color(color.blue, "", group="Plot 3", inline="p3_style")
input_p3_width = input.int(1, "", group="Plot 3", inline="p3_style", minval=1, maxval=4)
input_p3_label = input.string("Prev. Day high", "Label", group="Plot 3", inline="p3_label")
input_p3_extend = input.bool(false, "Extend Line", group="Plot 3", inline="p3_style")

input_p4_enable = input.bool(true, "", group="Plot 4", inline="p4", tooltip="Choose the current or the previous candles OHLC on specific timeframe.")
input_p4_candle = input.string("Previous", "", group="Plot 4", options=["Current", "Previous"], inline="p4")
input_p4_tf = input.timeframe("D", "", group="Plot 4", inline="p4")
input_p4_ohlc = input.string("L", "", group="Plot 4", options=["O", "H", "L", "C"], inline="p4")
input_p4_style = input.string("Solid", "", group="Plot 4", options=["Solid", "Dashed", "Dotted"], inline="p4_style")
input_p4_color = input.color(color.red, "", group="Plot 4", inline="p4_style")
input_p4_width = input.int(1, "", group="Plot 4", inline="p4_style", minval=1, maxval=4)
input_p4_label = input.string("Prev. Day low", "Label", group="Plot 4", inline="p4_label")
input_p4_extend = input.bool(false, "Extend Line", group="Plot 4", inline="p4_style")

input_p5_enable = input.bool(true, "", group="Plot 5", inline="p5", tooltip="Choose the current or the previous candles OHLC on specific timeframe.")
input_p5_candle = input.string("Current", "", group="Plot 5", options=["Current", "Previous"], inline="p5")
input_p5_tf = input.timeframe("D", "", group="Plot 5", inline="p5")
input_p5_ohlc = input.string("O", "", group="Plot 5", options=["O", "H", "L", "C"], inline="p5")
input_p5_style = input.string("Dotted", "", group="Plot 5", options=["Solid", "Dashed", "Dotted"], inline="p5_style")
input_p5_color = input.color(color.green, "", group="Plot 5", inline="p5_style")
input_p5_width = input.int(1, "", group="Plot 5", inline="p5_style", minval=1, maxval=4)
input_p5_label = input.string("Current Day Open", "Label", group="Plot 5", inline="p5_label")
input_p5_extend = input.bool(false, "Extend Line", group="Plot 5", inline="p5_style")

input_p6_enable = input.bool(true, "", group="Plot 6", inline="p6", tooltip="Choose the current or the previous candles OHLC on specific timeframe.")
input_p6_candle = input.string("Current", "", group="Plot 6", options=["Current", "Previous"], inline="p6")
input_p6_tf = input.timeframe("D", "", group="Plot 6", inline="p6")
input_p6_ohlc = input.string("C", "", group="Plot 6", options=["O", "H", "L", "C"], inline="p6")
input_p6_style = input.string("Dotted", "", group="Plot 6", options=["Solid", "Dashed", "Dotted"], inline="p6_style")
input_p6_color = input.color(color.green, "", group="Plot 6", inline="p6_style")
input_p6_width = input.int(1, "", group="Plot 6", inline="p6_style", minval=1, maxval=4)
input_p6_label = input.string("Current Day Close", "Label", group="Plot 6", inline="p6_label")
input_p6_extend = input.bool(false, "Extend Line", group="Plot 6", inline="p6_style")

input_p7_enable = input.bool(true, "", group="Plot 7", inline="p7", tooltip="Choose the current or the previous candles OHLC on specific timeframe.")
input_p7_candle = input.string("Current", "", group="Plot 7", options=["Current", "Previous"], inline="p7")
input_p7_tf = input.timeframe("D", "", group="Plot 7", inline="p7")
input_p7_ohlc = input.string("H", "", group="Plot 7", options=["O", "H", "L", "C"], inline="p7")
input_p7_style = input.string("Dotted", "", group="Plot 7", options=["Solid", "Dashed", "Dotted"], inline="p7_style")
input_p7_color = input.color(color.blue, "", group="Plot 7", inline="p7_style")
input_p7_width = input.int(1, "", group="Plot 7", inline="p7_style", minval=1, maxval=4)
input_p7_label = input.string("Current Day High", "Label", group="Plot 7", inline="p7_label")
input_p7_extend = input.bool(false, "Extend Line", group="Plot 7", inline="p7_style")

input_p8_enable = input.bool(true, "", group="Plot 8", inline="p8", tooltip="Choose the current or the previous candles OHLC on specific timeframe.")
input_p8_candle = input.string("Current", "", group="Plot 8", options=["Current", "Previous"], inline="p8")
input_p8_tf = input.timeframe("D", "", group="Plot 8", inline="p8")
input_p8_ohlc = input.string("L", "", group="Plot 8", options=["O", "H", "L", "C"], inline="p8")
input_p8_style = input.string("Dotted", "", group="Plot 8", options=["Solid", "Dashed", "Dotted"], inline="p8_style")
input_p8_color = input.color(color.red, "", group="Plot 8", inline="p8_style")
input_p8_width = input.int(1, "", group="Plot 8", inline="p8_style", minval=1, maxval=4)
input_p8_label = input.string("Current Day Low", "Label", group="Plot 8", inline="p8_label")
input_p8_extend = input.bool(false, "Extend Line", group="Plot 8", inline="p8_style")

input_p9_enable = input.bool(false, "", group="Plot 9", inline="p9", tooltip="Choose the current or the previous candles OHLC on specific timeframe.")
input_p9_candle = input.string("Previous", "", group="Plot 9", options=["Current", "Previous"], inline="p9")
input_p9_tf = input.timeframe("D", "", group="Plot 9", inline="p9")
input_p9_ohlc = input.string("O", "", group="Plot 9", options=["O", "H", "L", "C"], inline="p9")
input_p9_style = input.string("Solid", "", group="Plot 9", options=["Solid", "Dashed", "Dotted"], inline="p9_style")
input_p9_color = input.color(color.green, "", group="Plot 9", inline="p9_style")
input_p9_width = input.int(1, "", group="Plot 9", inline="p9_style", minval=1, maxval=4)
input_p9_label = input.string("Custom 1", "Label", group="Plot 9", inline="p9_label")
input_p9_extend = input.bool(false, "Extend Line", group="Plot 9", inline="p9_style")

input_p10_enable = input.bool(false, "", group="Plot 10", inline="p10", tooltip="Choose the current or the previous candles OHLC on specific timeframe.")
input_p10_candle = input.string("Previous", "", group="Plot 10", options=["Current", "Previous"], inline="p10")
input_p10_tf = input.timeframe("D", "", group="Plot 10", inline="p10")
input_p10_ohlc = input.string("O", "", group="Plot 10", options=["O", "H", "L", "C"], inline="p10")
input_p10_style = input.string("Solid", "", group="Plot 10", options=["Solid", "Dashed", "Dotted"], inline="p10_style")
input_p10_color = input.color(color.green, "", group="Plot 10", inline="p10_style")
input_p10_width = input.int(1, "", group="Plot 10", inline="p10_style", minval=1, maxval=4)
input_p10_label = input.string("Custom 2", "Label", group="Plot 10", inline="p10_label")
input_p10_extend = input.bool(false, "Extend Line", group="Plot 10", inline="p10_style")

// =================== Preset Settings Storage ===================
// Színek definiálása
var color PRESET_BLUE = #728acc
var color PRESET_RED = #c25f67
var color PRESET_GREEN = #86c1a7
var color PRESET_DAILY_FIB = #e17261

// Custom beállítások mentése/betöltése
var bool is_first_run = true
var string previous_preset = "Custom"

// Custom beállítások tárolása
// Plot 1 custom tárolás
var bool custom_p1_enable = false
var string custom_p1_candle = ""
var string custom_p1_tf = ""
var string custom_p1_ohlc = ""
var string custom_p1_style = ""
var color custom_p1_color = color.blue
var int custom_p1_width = 1
var string custom_p1_label = ""
var bool custom_p1_extend = false
// Plot 2 custom tárolás
var bool custom_p2_enable = false
var string custom_p2_candle = ""
var string custom_p2_tf = ""
var string custom_p2_ohlc = ""
var string custom_p2_style = ""
var color custom_p2_color = color.red
var int custom_p2_width = 1
var string custom_p2_label = ""
var bool custom_p2_extend = false
// Plot 3 custom tárolás
var bool custom_p3_enable = false
var string custom_p3_candle = ""
var string custom_p3_tf = ""
var string custom_p3_ohlc = ""
var string custom_p3_style = ""
var color custom_p3_color = color.blue
var int custom_p3_width = 1
var string custom_p3_label = ""
var bool custom_p3_extend = false
// Plot 4 custom tárolás
var bool custom_p4_enable = false
var string custom_p4_candle = ""
var string custom_p4_tf = ""
var string custom_p4_ohlc = ""
var string custom_p4_style = ""
var color custom_p4_color = color.red
var int custom_p4_width = 1
var string custom_p4_label = ""
var bool custom_p4_extend = false
// Plot 5 custom tárolás
var bool custom_p5_enable = false
var string custom_p5_candle = ""
var string custom_p5_tf = ""
var string custom_p5_ohlc = ""
var string custom_p5_style = ""
var color custom_p5_color = color.green
var int custom_p5_width = 1
var string custom_p5_label = ""
var bool custom_p5_extend = false
// Plot 6 custom tárolás
var bool custom_p6_enable = false
var string custom_p6_candle = ""
var string custom_p6_tf = ""
var string custom_p6_ohlc = ""
var string custom_p6_style = ""
var color custom_p6_color = color.green
var int custom_p6_width = 1
var string custom_p6_label = ""
var bool custom_p6_extend = false
// Plot 7 custom tárolás
var bool custom_p7_enable = false
var string custom_p7_candle = ""
var string custom_p7_tf = ""
var string custom_p7_ohlc = ""
var string custom_p7_style = ""
var color custom_p7_color = color.blue
var int custom_p7_width = 1
var string custom_p7_label = ""
var bool custom_p7_extend = false
// Plot 8 custom tárolás
var bool custom_p8_enable = false
var string custom_p8_candle = ""
var string custom_p8_tf = ""
var string custom_p8_ohlc = ""
var string custom_p8_style = ""
var color custom_p8_color = color.red
var int custom_p8_width = 1
var string custom_p8_label = ""
var bool custom_p8_extend = false
// Plot 9 custom tárolás
var bool custom_p9_enable = false
var string custom_p9_candle = ""
var string custom_p9_tf = ""
var string custom_p9_ohlc = ""
var string custom_p9_style = ""
var color custom_p9_color = color.green
var int custom_p9_width = 1
var string custom_p9_label = ""
var bool custom_p9_extend = false
// Plot 10 custom tárolás
var bool custom_p10_enable = false
var string custom_p10_candle = ""
var string custom_p10_tf = ""
var string custom_p10_ohlc = ""
var string custom_p10_style = ""
var color custom_p10_color = color.green
var int custom_p10_width = 1
var string custom_p10_label = ""
var bool custom_p10_extend = false


// Preset váltás detektálása
bool is_preset_changed = selected_preset != previous_preset

// Watermark megjelenítése
if barstate.islast
    var label watermark = na
    if na(watermark)
        watermark := label.new(bar_index, high, 
             text="Custom Framework Builder\nPreset: " + selected_preset,
             style=label.style_label_center,
             color=color.new(color.black, 100),
             textcolor=color.black,
             size=size.large,
             yloc=yloc.price)
    else
        label.set_xy(watermark, bar_index, high)
        label.set_text(watermark, "Custom Framework Builder\nPreset: " + selected_preset)

// Preset váltás kezelése
if is_preset_changed and previous_preset == "Custom" and not is_first_run
    // Custom beállítások mentése változókba
    custom_p1_enable := p1_enable
    custom_p1_candle := p1_candle
    custom_p1_tf := p1_tf
    custom_p1_ohlc := p1_ohlc
    custom_p1_style := p1_style
    custom_p1_color := p1_color
    custom_p1_width := p1_width
    custom_p1_label := p1_label
    custom_p1_extend := p1_extend
    custom_p2_enable := p2_enable
    custom_p2_candle := p2_candle
    custom_p2_tf := p2_tf
    custom_p2_ohlc := p2_ohlc
    custom_p2_style := p2_style
    custom_p2_color := p2_color
    custom_p2_width := p2_width
    custom_p2_label := p2_label
    custom_p2_extend := p2_extend
    custom_p3_enable := p3_enable
    custom_p3_candle := p3_candle
    custom_p3_tf := p3_tf
    custom_p3_ohlc := p3_ohlc
    custom_p3_style := p3_style
    custom_p3_color := p3_color
    custom_p3_width := p3_width
    custom_p3_label := p3_label
    custom_p3_extend := p3_extend
    custom_p4_enable := p4_enable
    custom_p4_candle := p4_candle
    custom_p4_tf := p4_tf
    custom_p4_ohlc := p4_ohlc
    custom_p4_style := p4_style
    custom_p4_color := p4_color
    custom_p4_width := p4_width
    custom_p4_label := p4_label
    custom_p4_extend := p4_extend
    custom_p5_enable := p5_enable
    custom_p5_candle := p5_candle
    custom_p5_tf := p5_tf
    custom_p5_ohlc := p5_ohlc
    custom_p5_style := p5_style
    custom_p5_color := p5_color
    custom_p5_width := p5_width
    custom_p5_label := p5_label
    custom_p5_extend := p5_extend
    custom_p6_enable := p6_enable
    custom_p6_candle := p6_candle
    custom_p6_tf := p6_tf
    custom_p6_ohlc := p6_ohlc
    custom_p6_style := p6_style
    custom_p6_color := p6_color
    custom_p6_width := p6_width
    custom_p6_label := p6_label
    custom_p6_extend := p6_extend
    custom_p7_enable := p7_enable
    custom_p7_candle := p7_candle
    custom_p7_tf := p7_tf
    custom_p7_ohlc := p7_ohlc
    custom_p7_style := p7_style
    custom_p7_color := p7_color
    custom_p7_width := p7_width
    custom_p7_label := p7_label
    custom_p7_extend := p7_extend
    custom_p8_enable := p8_enable
    custom_p8_candle := p8_candle
    custom_p8_tf := p8_tf
    custom_p8_ohlc := p8_ohlc
    custom_p8_style := p8_style
    custom_p8_color := p8_color
    custom_p8_width := p8_width
    custom_p8_label := p8_label
    custom_p8_extend := p8_extend
    custom_p9_enable := p9_enable
    custom_p9_candle := p9_candle
    custom_p9_tf := p9_tf
    custom_p9_ohlc := p9_ohlc
    custom_p9_style := p9_style
    custom_p9_color := p9_color
    custom_p9_width := p9_width
    custom_p9_label := p9_label
    custom_p9_extend := p9_extend
    custom_p10_enable := p10_enable
    custom_p10_candle := p10_candle
    custom_p10_tf := p10_tf
    custom_p10_ohlc := p10_ohlc
    custom_p10_style := p10_style
    custom_p10_color := p10_color
    custom_p10_width := p10_width
    custom_p10_label := p10_label
    custom_p10_extend := p10_extend

// Preset beállítások alkalmazása
if is_preset_changed
    if selected_preset == "Weekly Orderflow"
        // Weekly Orderflow preset beállításai
        p1_enable := true
        p1_candle := "Previous"
        p1_tf := "W"
        p1_ohlc := "H"
        p1_style := "Solid"
        p1_color := PRESET_BLUE
        p1_width := 2
        p1_label := "Prev. Week High"
        p1_extend := false
        is_first_run := false
        p2_enable := true
        p2_candle := "Previous"
        p2_tf := "W"
        p2_ohlc := "L"
        p2_style := "Solid"
        p2_color := PRESET_RED
        p2_width := 2
        p2_label := "Prev. Week Low"
        p2_extend := false
        p3_enable := true
        p3_candle := "Previous"
        p3_tf := "D"
        p3_ohlc := "H"
        p3_style := "Dashed"
        p3_color := PRESET_BLUE
        p3_width := 1
        p3_label := "Prev. Day High"
        p3_extend := false
        p4_enable := true
        p4_candle := "Previous"
        p4_tf := "D"
        p4_ohlc := "L"
        p4_style := "Dashed"
        p4_color := PRESET_RED
        p4_width := 1
        p4_label := "Prev. Day Low"
        p4_extend := false
        p5_enable := true
        p5_candle := "Current"
        p5_tf := "D"
        p5_ohlc := "O"
        p5_style := "Dotted"
        p5_color := PRESET_GREEN
        p5_width := 1
        p5_label := "Current Day Open"
        p5_extend := false
        p6_enable := true
        p6_candle := "Current"
        p6_tf := "D"
        p6_ohlc := "C"
        p6_style := "Dotted"
        p6_color := PRESET_GREEN
        p6_width := 1
        p6_label := "Current Day Close"
        p6_extend := false
        p7_enable := true
        p7_candle := "Current"
        p7_tf := "D"
        p7_ohlc := "H"
        p7_style := "Dotted"
        p7_color := PRESET_BLUE
        p7_width := 1
        p7_label := "Current Day High"
        p7_extend := false
        p8_enable := true
        p8_candle := "Current"
        p8_tf := "D"
        p8_ohlc := "L"
        p8_style := "Dotted"
        p8_color := PRESET_RED
        p8_width := 1
        p8_label := "Current Day Low"
        p8_extend := false
        p9_enable := false
        p9_candle := "Previous"
        p9_tf := "D"
        p9_ohlc := "O"
        p9_style := "Solid"
        p9_color := PRESET_GREEN
        p9_width := 1
        p9_label := "Custom 1"
        p9_extend := false
        p10_enable := false
        p10_candle := "Previous"
        p10_tf := "D"
        p10_ohlc := "O"
        p10_style := "Solid"
        p10_color := PRESET_GREEN
        p10_width := 1
        p10_label := "Custom 2"
        p10_extend := false
    else if selected_preset == "Daily Orderflow"
        // Daily Orderflow preset beállításai
        p1_enable := true
        p1_candle := "Previous"
        p1_tf := "D"
        p1_ohlc := "H"
        p1_style := "Solid"
        p1_color := PRESET_BLUE
        p1_width := 1
        p1_label := "Prev. Day High"
        p1_extend := false
        is_first_run := false
        p2_enable := true
        p2_candle := "Previous"
        p2_tf := "D"
        p2_ohlc := "L"
        p2_style := "Solid"
        p2_color := PRESET_RED
        p2_width := 1
        p2_label := "Prev. Day Low"
        p2_extend := false
        p3_enable := true
        p3_candle := "Previous"
        p3_tf := "60"  // Módosítva 240-ről 60-ra (1 órás)
        p3_ohlc := "H"
        p3_style := "Dashed"
        p3_color := PRESET_BLUE
        p3_width := 1
        p3_label := "Prev. 1H High"  // Címke frissítve
        p3_extend := false
        p4_enable := true
        p4_candle := "Previous"
        p4_tf := "60"
        p4_ohlc := "L"
        p4_style := "Dashed"
        p4_color := PRESET_RED
        p4_width := 1
        p4_label := "Prev. 1H Low"
        p4_extend := false
        p5_enable := true
        p5_candle := "Current"
        p5_tf := "D"
        p5_ohlc := "O"
        p5_style := "Dotted"
        p5_color := PRESET_GREEN
        p5_width := 1
        p5_label := "Current Day Open"
        p5_extend := false
        p6_enable := true
        p6_candle := "Current"
        p6_tf := "D"
        p6_ohlc := "C"
        p6_style := "Dotted"
        p6_color := PRESET_GREEN
        p6_width := 1
        p6_label := "Current Day Close"
        p6_extend := false
        p7_enable := true
        p7_candle := "Current"
        p7_tf := "D"
        p7_ohlc := "H"
        p7_style := "Dotted"
        p7_color := PRESET_BLUE
        p7_width := 1
        p7_label := "Current Day High"
        p7_extend := false
        p8_enable := true
        p8_candle := "Current"
        p8_tf := "D"
        p8_ohlc := "L"
        p8_style := "Dotted"
        p8_color := PRESET_RED
        p8_width := 1
        p8_label := "Current Day Low"
        p8_extend := false
        p9_enable := false
        p9_candle := "Previous"
        p9_tf := "D"
        p9_ohlc := "O"
        p9_style := "Solid"
        p9_color := PRESET_GREEN
        p9_width := 1
        p9_label := "Custom 1"
        p9_extend := false
        p10_enable := false
        p10_candle := "Previous"
        p10_tf := "D"
        p10_ohlc := "O"
        p10_style := "Solid"
        p10_color := PRESET_GREEN
        p10_width := 1
        p10_label := "Custom 2"
        p10_extend := false
    else if selected_preset == "Custom" and not is_first_run
        // Custom beállítások visszaállítása
        p1_enable := custom_p1_enable
        p1_candle := custom_p1_candle
        p1_tf := custom_p1_tf
        p1_ohlc := custom_p1_ohlc
        p1_style := custom_p1_style
        p1_color := custom_p1_color
        p1_width := custom_p1_width
        p1_label := custom_p1_label
        p1_extend := custom_p1_extend
        p2_enable := custom_p2_enable
        p2_candle := custom_p2_candle
        p2_tf := custom_p2_tf
        p2_ohlc := custom_p2_ohlc
        p2_style := custom_p2_style
        p2_color := custom_p2_color
        p2_width := custom_p2_width
        p2_label := custom_p2_label
        p2_extend := custom_p2_extend
        p3_enable := custom_p3_enable
        p3_candle := custom_p3_candle
        p3_tf := custom_p3_tf
        p3_ohlc := custom_p3_ohlc
        p3_style := custom_p3_style
        p3_color := custom_p3_color
        p3_width := custom_p3_width
        p3_label := custom_p3_label
        p3_extend := custom_p3_extend
        p4_enable := custom_p4_enable
        p4_candle := custom_p4_candle
        p4_tf := custom_p4_tf
        p4_ohlc := custom_p4_ohlc
        p4_style := custom_p4_style
        p4_color := custom_p4_color
        p4_width := custom_p4_width
        p4_label := custom_p4_label
        p4_extend := custom_p4_extend
        p5_enable := custom_p5_enable
        p5_candle := custom_p5_candle
        p5_tf := custom_p5_tf
        p5_ohlc := custom_p5_ohlc
        p5_style := custom_p5_style
        p5_color := custom_p5_color
        p5_width := custom_p5_width
        p5_label := custom_p5_label
        p5_extend := custom_p5_extend
        p6_enable := custom_p6_enable
        p6_candle := custom_p6_candle
        p6_tf := custom_p6_tf
        p6_ohlc := custom_p6_ohlc
        p6_style := custom_p6_style
        p6_color := custom_p6_color
        p6_width := custom_p6_width
        p6_label := custom_p6_label
        p6_extend := custom_p6_extend
        p7_enable := custom_p7_enable
        p7_candle := custom_p7_candle
        p7_tf := custom_p7_tf
        p7_ohlc := custom_p7_ohlc
        p7_style := custom_p7_style
        p7_color := custom_p7_color
        p7_width := custom_p7_width
        p7_label := custom_p7_label
        p7_extend := custom_p7_extend
        p8_enable := custom_p8_enable
        p8_candle := custom_p8_candle
        p8_tf := custom_p8_tf
        p8_ohlc := custom_p8_ohlc
        p8_style := custom_p8_style
        p8_color := custom_p8_color
        p8_width := custom_p8_width
        p8_label := custom_p8_label
        p8_extend := custom_p8_extend
        p9_enable := custom_p9_enable
        p9_candle := custom_p9_candle
        p9_tf := custom_p9_tf
        p9_ohlc := custom_p9_ohlc
        p9_style := custom_p9_style
        p9_color := custom_p9_color
        p9_width := custom_p9_width
        p9_label := custom_p9_label
        p9_extend := custom_p9_extend
        p10_enable := custom_p10_enable
        p10_candle := custom_p10_candle
        p10_tf := custom_p10_tf
        p10_ohlc := custom_p10_ohlc
        p10_style := custom_p10_style
        p10_color := custom_p10_color
        p10_width := custom_p10_width
        p10_label := custom_p10_label
        p10_extend := custom_p10_extend

    previous_preset := selected_preset

// Az input értékek szinkronizálása a runtime változókkal
p1_enable := input_p1_enable
p1_candle := input_p1_candle
p1_tf := input_p1_tf
p1_ohlc := input_p1_ohlc
p1_style := input_p1_style
p1_color := input_p1_color
p1_width := input_p1_width
p1_label := input_p1_label
p1_extend := input_p1_extend

p2_enable := input_p2_enable
p2_candle := input_p2_candle
p2_tf := input_p2_tf
p2_ohlc := input_p2_ohlc
p2_style := input_p2_style
p2_color := input_p2_color
p2_width := input_p2_width
p2_label := input_p2_label
p2_extend := input_p2_extend

p3_enable := input_p3_enable
p3_candle := input_p3_candle
p3_tf := input_p3_tf
p3_ohlc := input_p3_ohlc
p3_style := input_p3_style
p3_color := input_p3_color
p3_width := input_p3_width
p3_label := input_p3_label
p3_extend := input_p3_extend

p4_enable := input_p4_enable
p4_candle := input_p4_candle
p4_tf := input_p4_tf
p4_ohlc := input_p4_ohlc
p4_style := input_p4_style
p4_color := input_p4_color
p4_width := input_p4_width
p4_label := input_p4_label
p4_extend := input_p4_extend

p5_enable := input_p5_enable
p5_candle := input_p5_candle
p5_tf := input_p5_tf
p5_ohlc := input_p5_ohlc
p5_style := input_p5_style
p5_color := input_p5_color
p5_width := input_p5_width
p5_label := input_p5_label
p5_extend := input_p5_extend

p6_enable := input_p6_enable
p6_candle := input_p6_candle
p6_tf := input_p6_tf
p6_ohlc := input_p6_ohlc
p6_style := input_p6_style
p6_color := input_p6_color
p6_width := input_p6_width
p6_label := input_p6_label
p6_extend := input_p6_extend

p7_enable := input_p7_enable
p7_candle := input_p7_candle
p7_tf := input_p7_tf
p7_ohlc := input_p7_ohlc
p7_style := input_p7_style
p7_color := input_p7_color
p7_width := input_p7_width
p7_label := input_p7_label
p7_extend := input_p7_extend

p8_enable := input_p8_enable
p8_candle := input_p8_candle
p8_tf := input_p8_tf
p8_ohlc := input_p8_ohlc
p8_style := input_p8_style
p8_color := input_p8_color
p8_width := input_p8_width
p8_label := input_p8_label
p8_extend := input_p8_extend

p9_enable := input_p9_enable
p9_candle := input_p9_candle
p9_tf := input_p9_tf
p9_ohlc := input_p9_ohlc
p9_style := input_p9_style
p9_color := input_p9_color
p9_width := input_p9_width
p9_label := input_p9_label
p9_extend := input_p9_extend

p10_enable := input_p10_enable
p10_candle := input_p10_candle
p10_tf := input_p10_tf
p10_ohlc := input_p10_ohlc
p10_style := input_p10_style
p10_color := input_p10_color
p10_width := input_p10_width
p10_label := input_p10_label
p10_extend := input_p10_extend

// =================== RÉGI Input mezők ===================

// Fibonacci 1 beállítások
fib1_enable = input.bool(true, "Enable Fibonacci 1", group="Fibonacci 1", inline="fib1_main")
fib1_plot1 = input.string("Plot 1", "First Plot", tooltip="Fibonacci 1 start point", group="Fibonacci 1", 
     options=["Plot 1", "Plot 2", "Plot 3", "Plot 4", "Plot 5", "Plot 6", "Plot 7", "Plot 8", "Plot 9", "Plot 10"])
fib1_plot2 = input.string("Plot 2", "Second Plot", tooltip="Fibonacci 1 end point", group="Fibonacci 1", 
     options=["Plot 1", "Plot 2", "Plot 3", "Plot 4", "Plot 5", "Plot 6", "Plot 7", "Plot 8", "Plot 9", "Plot 10"])
fib1_color = input.color(color.black, "Color", group="Fibonacci 1", inline="fib1_style")
fib1_width = input.int(1, "Width", group="Fibonacci 1", inline="fib1_style", minval=1, maxval=4)
fib1_line_style = input.string("Dashed", "Style", group="Fibonacci 1", options=["Solid", "Dashed", "Dotted"], inline="fib1_style")
fib1_extend = input.bool(false, "Extend Lines", group="Fibonacci 1", inline="fib1_style")

// Fibonacci 2 beállítások
fib2_enable = input.bool(false, "Enable Fibonacci 2", group="Fibonacci 2", inline="fib2_main")
fib2_plot1 = input.string("Plot 3", "First Plot", tooltip="Fibonacci 2 start point", group="Fibonacci 2", 
     options=["Plot 1", "Plot 2", "Plot 3", "Plot 4", "Plot 5", "Plot 6", "Plot 7", "Plot 8", "Plot 9", "Plot 10"])
fib2_plot2 = input.string("Plot 4", "Second Plot", tooltip="Fibonacci 2 end point", group="Fibonacci 2", 
     options=["Plot 1", "Plot 2", "Plot 3", "Plot 4", "Plot 5", "Plot 6", "Plot 7", "Plot 8", "Plot 9", "Plot 10"])
fib2_color = input.color(color.gray, "Color", group="Fibonacci 2", inline="fib2_style")
fib2_width = input.int(1, "Width", group="Fibonacci 2", inline="fib2_style", minval=1, maxval=4)
fib2_line_style = input.string("Dashed", "Style", group="Fibonacci 2", options=["Solid", "Dashed", "Dotted"], inline="fib2_style")
fib2_extend = input.bool(false, "Extend Lines", group="Fibonacci 2", inline="fib2_style")

// Fibonacci 3 beállítások
fib3_enable = input.bool(false, "Enable Fibonacci 3", group="Fibonacci 3", inline="fib3_main")
fib3_plot1 = input.string("Plot 6", "First Plot", tooltip="Fibonacci 3 start point", group="Fibonacci 3", 
     options=["Plot 1", "Plot 2", "Plot 3", "Plot 4", "Plot 5", "Plot 6", "Plot 7", "Plot 8", "Plot 9", "Plot 10"])
fib3_plot2 = input.string("Plot 7", "Second Plot", tooltip="Fibonacci 3 end point", group="Fibonacci 3", 
     options=["Plot 1", "Plot 2", "Plot 3", "Plot 4", "Plot 5", "Plot 6", "Plot 7", "Plot 8", "Plot 9", "Plot 10"])
fib3_color = input.color(color.gray, "Color", group="Fibonacci 3", inline="fib3_style")
fib3_width = input.int(1, "Width", group="Fibonacci 3", inline="fib3_style", minval=1, maxval=4)
fib3_line_style = input.string("Dashed", "Style", group="Fibonacci 3", options=["Solid", "Dashed", "Dotted"], inline="fib3_style")
fib3_extend = input.bool(false, "Extend Lines", group="Fibonacci 3", inline="fib3_style")

// Fibonacci 4 beállítások
fib4_enable = input.bool(false, "Enable Fibonacci 4", group="Fibonacci 4", inline="fib4_main")
fib4_plot1 = input.string("Plot 8", "First Plot", tooltip="Fibonacci 4 start point", group="Fibonacci 4", 
     options=["Plot 1", "Plot 2", "Plot 3", "Plot 4", "Plot 5", "Plot 6", "Plot 7", "Plot 8", "Plot 9", "Plot 10"])
fib4_plot2 = input.string("Plot 9", "Second Plot", tooltip="Fibonacci 4 end point", group="Fibonacci 4", 
     options=["Plot 1", "Plot 2", "Plot 3", "Plot 4", "Plot 5", "Plot 6", "Plot 7", "Plot 8", "Plot 9", "Plot 10"])
fib4_color = input.color(color.gray, "Color", group="Fibonacci 4", inline="fib4_style")
fib4_width = input.int(1, "Width", group="Fibonacci 4", inline="fib4_style", minval=1, maxval=4)
fib4_line_style = input.string("Dashed", "Style", group="Fibonacci 4", options=["Solid", "Dashed", "Dotted"], inline="fib4_style")
fib4_extend = input.bool(false, "Extend Lines", group="Fibonacci 4", inline="fib4_style")

// Fibonacci 5 beállítások
fib5_enable = input.bool(false, "Enable Fibonacci 5", group="Fibonacci 5", inline="fib5_main")
fib5_plot1 = input.string("Plot 1", "First Plot", tooltip="Fibonacci 5 start point", group="Fibonacci 5", 
     options=["Plot 1", "Plot 2", "Plot 3", "Plot 4", "Plot 5", "Plot 6", "Plot 7", "Plot 8", "Plot 9", "Plot 10"])
fib5_plot2 = input.string("Plot 2", "Second Plot", tooltip="Fibonacci 5 end point", group="Fibonacci 5", 
     options=["Plot 1", "Plot 2", "Plot 3", "Plot 4", "Plot 5", "Plot 6", "Plot 7", "Plot 8", "Plot 9", "Plot 10"])
fib5_color = input.color(color.gray, "Color", group="Fibonacci 5", inline="fib5_style")
fib5_width = input.int(1, "Width", group="Fibonacci 5", inline="fib5_style", minval=1, maxval=4)
fib5_line_style = input.string("Dashed", "Style", group="Fibonacci 5", options=["Solid", "Dashed", "Dotted"], inline="fib5_style")
fib5_extend = input.bool(false, "Extend Lines", group="Fibonacci 5", inline="fib5_style")

// =================== Segéd függvények ===================
// Gyeryta adatok lekérése
// Debug információkat adunk a kódhoz
f_get_candle_data(tf_input, is_current) =>
    if timeframe.in_seconds(tf_input) > timeframe.in_seconds(timeframe.period)
        if is_current
            [curr_o, curr_h, curr_l, curr_c] = request.security(syminfo.tickerid, tf_input, [open, high, low, close], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
            [curr_o, curr_h, curr_l, curr_c]
        else
            [prev_o, prev_h, prev_l, prev_c] = request.security(syminfo.tickerid, tf_input, [open[1], high[1], low[1], close[1]], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
            [prev_o, prev_h, prev_l, prev_c]
    else
        if is_current
            [open, high, low, close]
        else
            [open[1], high[1], low[1], close[1]]

// Fibonacci rajzolás függvénye

f_draw_fibonacci_levels(value1, value2, fib_color, fib_width, fib_style, start_time, end_time, fib_extended) =>
    if na(value1) or na(value2)
        [na, na, na]
    else
        // Stílus beállítása
        line_style = switch fib_style
            "Solid" => line.style_solid
            "Dashed" => line.style_dashed
            => line.style_dotted
        
        // Fibonacci szintek számítása
        diff = value2 - value1
        fib_levels = array.from(0.0, 0.236, 0.382, 0.5, 0.618, 0.786, 1.0)
        fib_labels = array.from("0%", "23.6%", "38.2%", "50%", "61.8%", "78.6%", "100%")
        
        // Vonalak és címkék tárolása
        var line[] fib_lines = array.new_line(7, na)
        var label[] fib_labels_arr = array.new_label(7, na)
        
        // Label pozicionálási beállítások
        horizontal_offset = timeframe.in_seconds(timeframe.period) * 1000 * 1  // 1 gyertya
        
        // Extended vonal végpont számítása
        var int last_chart_time = int(time)
        if barstate.islast
            last_chart_time := int(time)
        
        actual_end_time = fib_extended ? int(last_chart_time + (timeframe.in_seconds(timeframe.period) * 1000 * 3)) : end_time
        
        // Vonalak frissítése/létrehozása
        for i = 0 to 6
            level = value1 + (diff * array.get(fib_levels, i))
            label_text = array.get(fib_labels, i)
            
            line_exists = not na(array.get(fib_lines, i))
            if line_exists
                line.set_xy1(array.get(fib_lines, i), start_time, level)
                line.set_xy2(array.get(fib_lines, i), actual_end_time, level)
                line.set_color(array.get(fib_lines, i), fib_color)
                line.set_width(array.get(fib_lines, i), fib_width)
                line.set_style(array.get(fib_lines, i), line_style)
                
                label.set_xy(array.get(fib_labels_arr, i), 
                     actual_end_time - horizontal_offset, level)
                label.set_text(array.get(fib_labels_arr, i), label_text)
                label.set_textcolor(array.get(fib_labels_arr, i), fib_color)
            else
                fib_line = line.new(x1=start_time, y1=level, x2=actual_end_time, y2=level, 
                     color=fib_color, width=fib_width, style=line_style, 
                     xloc=xloc.bar_time)
                array.set(fib_lines, i, fib_line)
                
                fib_label = label.new(x=actual_end_time - horizontal_offset, y=level,
                     text=label_text, 
                     xloc=xloc.bar_time, style=label.style_label_left, 
                     textcolor=fib_color, size=size.tiny, color=color.new(fib_color, 100))
                array.set(fib_labels_arr, i, fib_label)
        
        [value1, start_time, actual_end_time]

// =================== Plot-ok kezelése ===================

// Plot Settings struktúra
type PlotSettings
    bool enable
    string candle_type
    string timeframe
    string ohlc_value
    string style
    color color
    int width
    string label
    bool extend

// Plot Settings létrehozása
plot1_settings = PlotSettings.new(p1_enable, p1_candle, p1_tf, p1_ohlc, p1_style, p1_color, p1_width, p1_label, p1_extend)
plot2_settings = PlotSettings.new(p2_enable, p2_candle, p2_tf, p2_ohlc, p2_style, p2_color, p2_width, p2_label, p2_extend)
plot3_settings = PlotSettings.new(p3_enable, p3_candle, p3_tf, p3_ohlc, p3_style, p3_color, p3_width, p3_label, p3_extend)
plot4_settings = PlotSettings.new(p4_enable, p4_candle, p4_tf, p4_ohlc, p4_style, p4_color, p4_width, p4_label, p4_extend)
plot5_settings = PlotSettings.new(p5_enable, p5_candle, p5_tf, p5_ohlc, p5_style, p5_color, p5_width, p5_label, p5_extend)
plot6_settings = PlotSettings.new(p6_enable, p6_candle, p6_tf, p6_ohlc, p6_style, p6_color, p6_width, p6_label, p6_extend)
plot7_settings = PlotSettings.new(p7_enable, p7_candle, p7_tf, p7_ohlc, p7_style, p7_color, p7_width, p7_label, p7_extend)
plot8_settings = PlotSettings.new(p8_enable, p8_candle, p8_tf, p8_ohlc, p8_style, p8_color, p8_width, p8_label, p8_extend)
plot9_settings = PlotSettings.new(p9_enable, p9_candle, p9_tf, p9_ohlc, p9_style, p9_color, p9_width, p9_label, p9_extend)
plot10_settings = PlotSettings.new(p10_enable, p10_candle, p10_tf, p10_ohlc, p10_style, p10_color, p10_width, p10_label, p10_extend)

// Értékek tárolása
var float[] plot_values = array.new_float(10, na)
var int[] plot_start_times = array.new_int(10, na)
var int[] plot_end_times = array.new_int(10, na)
var int[] plot_original_end_times = array.new_int(10, na)  // Új tömb az eredeti végpontoknak

f_handle_plot(plot_number, settings) =>
    if settings.enable
        // OHLC értékek lekérése
        is_current = settings.candle_type == "Current"
        [o, h, l, c] = f_get_candle_data(settings.timeframe, is_current)
        
        value = switch settings.ohlc_value
            "O" => o
            "H" => h
            "L" => l
            => c
        
        // Időpontok kezelése
        var int last_chart_time = int(time)
        var int last_bar_count = 0
        
        if barstate.islast
            last_chart_time := int(time)
            last_bar_count := bar_index
        
        extended_end_time = last_chart_time + (timeframe.in_seconds(timeframe.period) * 1000 * 3)
        
        // Kezdő és végpontok meghatározása
        int line_start_time = int(na)
        int line_end_time = int(na)
        int original_end_time = int(na)
        
        if is_current
            // Current esetén a jelenlegi időszak kezdetétől
            current_period_start = request.security(syminfo.tickerid, settings.timeframe, time)
            line_start_time := int(current_period_start)
            // Új logika: mindig 3 chart timeframe gyertyáig nyúlik
            original_end_time := int(last_chart_time + (timeframe.in_seconds(timeframe.period) * 1000 * 3))
            line_end_time := original_end_time  // Az extend már nem befolyásolja a Current vonalakat
        else
            // Previous esetén
            tf_seconds = timeframe.in_seconds(settings.timeframe)
            current_period_start = request.security(syminfo.tickerid, settings.timeframe, time)
            prev_period_start = request.security(syminfo.tickerid, settings.timeframe, time[1])
            prev_period_end = current_period_start
            
            line_start_time := int(prev_period_start)
            original_end_time := int(prev_period_end)
            line_end_time := settings.extend ? extended_end_time : original_end_time
        
        // Vonal stílus beállítása
        line_style = switch settings.style
            "Solid" => line.style_solid
            "Dashed" => line.style_dashed
            => line.style_dotted
        
        // Vonal és címke létrehozása/frissítése
        var line plot_line = na
        var label plot_label = na

        // Label pozicionálási beállítások
        horizontal_offset = timeframe.in_seconds(timeframe.period) * 1000 * 1  // 1 gyertya jobbra
        
        // Számoljuk meg, hány átfedő label van ezen az árszinten
        int overlapping_count = 0
        for i = 0 to plot_number - 1
            if math.abs(array.get(plot_values, i) - value) < syminfo.mintick * 10  // Nagyobb tűréshatár az átfedések detektálásához
                overlapping_count += 1

        // Label stílus kiválasztása az átfedések száma alapján
        label_style = switch overlapping_count % 5  // Használjuk a modulo operátort, hogy 5 után újrakezdje
            0 => label.style_label_left      // Nincs átfedés -> balra
            1 => label.style_label_upper_left // Első átfedés -> felső bal
            2 => label.style_label_lower_left // Második átfedés -> alsó bal
            3 => label.style_label_up         // Harmadik átfedés -> felfelé
            => label.style_label_down         // Negyedik átfedés -> lefelé

        if na(plot_line)
            plot_line := line.new(x1=line_start_time, y1=value, x2=line_end_time, y2=value,
                 color=settings.color, width=settings.width, style=line_style,
                 xloc=xloc.bar_time)
            plot_label := label.new(x=line_end_time + horizontal_offset, y=value, text=settings.label,
                 xloc=xloc.bar_time, style=label_style,
                 textcolor=settings.color, size=size.normal, color=color.new(settings.color, 90))
        else
            line.set_xy1(plot_line, line_start_time, value)
            line.set_xy2(plot_line, line_end_time, value)
            line.set_color(plot_line, settings.color)
            line.set_width(plot_line, settings.width)
            line.set_style(plot_line, line_style)
            
            label.set_xy(plot_label, line_end_time + horizontal_offset, value)
            label.set_text(plot_label, settings.label)
            label.set_textcolor(plot_label, settings.color)
            label.set_style(plot_label, label_style)
        
        array.set(plot_values, plot_number - 1, value)
        array.set(plot_start_times, plot_number - 1, line_start_time)
        array.set(plot_end_times, plot_number - 1, line_end_time)
        array.set(plot_original_end_times, plot_number - 1, original_end_time)
        
        [value, line_start_time, line_end_time, original_end_time]
    else
        [float(na), int(na), int(na), int(na)]

get_plot_values(plot_name) =>
    plot_idx = switch plot_name
        "Plot 1" => 0
        "Plot 2" => 1
        "Plot 3" => 2
        "Plot 4" => 3
        "Plot 5" => 4
        "Plot 6" => 5
        "Plot 7" => 6
        "Plot 8" => 7
        "Plot 9" => 8
        "Plot 10" => 9
        => -1
    
    if plot_idx >= 0
        [array.get(plot_values, plot_idx), 
         array.get(plot_start_times, plot_idx), 
         array.get(plot_end_times, plot_idx),
         array.get(plot_original_end_times, plot_idx)]
    else
        [na, na, na, na]

// Plot-ok számítása
[value1, start_time1, end_time1] = f_handle_plot(1, plot1_settings)
[value2, start_time2, end_time2] = f_handle_plot(2, plot2_settings)
[value3, start_time3, end_time3] = f_handle_plot(3, plot3_settings)
[value4, start_time4, end_time4] = f_handle_plot(4, plot4_settings)
[value5, start_time5, end_time5] = f_handle_plot(5, plot5_settings)
[value6, start_time6, end_time6] = f_handle_plot(6, plot6_settings)
[value7, start_time7, end_time7] = f_handle_plot(7, plot7_settings)
[value8, start_time8, end_time8] = f_handle_plot(8, plot8_settings)
[value9, start_time9, end_time9] = f_handle_plot(9, plot9_settings)
[value10, start_time10, end_time10] = f_handle_plot(10, plot10_settings)

// Fibonacci vonalak rajzolása
if barstate.islast
    // Fibonacci 1
    if fib1_enable
        [val1, start1, end1, orig_end1] = get_plot_values(fib1_plot1)
        [val2, start2, end2, orig_end2] = get_plot_values(fib1_plot2)
        if not na(val1) and not na(val2)
            end_time = orig_end2  // Mindig az eredeti végpontot használjuk
            f_draw_fibonacci_levels(val1, val2, fib1_color, fib1_width, fib1_line_style, start1, end_time, fib1_extend)

    // Fibonacci 2
    if fib2_enable
        [val1, start1, end1, orig_end1] = get_plot_values(fib2_plot1)
        [val2, start2, end2, orig_end2] = get_plot_values(fib2_plot2)
        if not na(val1) and not na(val2)
            end_time = orig_end2
            f_draw_fibonacci_levels(val1, val2, fib2_color, fib2_width, fib2_line_style, start1, end_time, fib2_extend)
    
    // Fibonacci 3
    if fib3_enable
        [val1, start1, end1, orig_end1] = get_plot_values(fib3_plot1)
        [val2, start2, end2, orig_end2] = get_plot_values(fib3_plot2)
        if not na(val1) and not na(val2)
            end_time = orig_end2
            f_draw_fibonacci_levels(val1, val2, fib3_color, fib3_width, fib3_line_style, start1, end_time, fib3_extend)
    
    // Fibonacci 4
    if fib4_enable
        [val1, start1, end1, orig_end1] = get_plot_values(fib4_plot1)
        [val2, start2, end2, orig_end2] = get_plot_values(fib4_plot2)
        if not na(val1) and not na(val2)
            end_time = orig_end2
            f_draw_fibonacci_levels(val1, val2, fib4_color, fib4_width, fib4_line_style, start1, end_time, fib4_extend)
    
    // Fibonacci 5
    if fib5_enable
        [val1, start1, end1, orig_end1] = get_plot_values(fib5_plot1)
        [val2, start2, end2, orig_end2] = get_plot_values(fib5_plot2)
        if not na(val1) and not na(val2)
            end_time = orig_end2
            f_draw_fibonacci_levels(val1, val2, fib5_color, fib5_width, fib5_line_style, start1, end_time, fib5_extend)
